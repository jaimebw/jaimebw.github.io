---
import PageLayout from "../layouts/PageLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

const posts = await getCollection("posts");
const tagsMap = new Map<string, CollectionEntry<"posts">[]>();

for (const post of posts) {
  (post.data.tags ?? []).forEach((tag) => {
    const bucket = tagsMap.get(tag) ?? [];
    bucket.push(post);
    tagsMap.set(tag, bucket);
  });
}

const tags = Array.from(tagsMap.entries()).sort(([a], [b]) =>
  a.localeCompare(b),
);

const formatDate = (value: Date) =>
  value.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
---
<PageLayout title="Tag Index" subtitle="Browse everything I've written">
  <h3>Overview</h3>
  <table>
    <thead>
      <tr>
        <th class="width-auto">Tag</th>
        <th class="width-min">Posts</th>
      </tr>
    </thead>
    <tbody>
      {tags.map(([tag, list]) => (
        <tr>
          <td>
            <a href={`#${tag}`}>{tag}</a>
          </td>
          <td>{list.length}</td>
        </tr>
      ))}
    </tbody>
  </table>

  {tags.map(([tag, list]) => (
    <section id={tag}>
      <h3>#{tag}</h3>
      <ul class="incremental">
        {list
          .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
          .map((post) => (
            <li>
              <a href={`/${post.slug}/`}>{post.data.title}</a>
              <br />
              <time datetime={post.data.date.toISOString()}>
                {formatDate(post.data.date)}
              </time>
            </li>
          ))}
      </ul>
    </section>
  ))}
</PageLayout>
